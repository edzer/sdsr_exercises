<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.34">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>17&nbsp; Spatial econometrics models – Spatial Data Science</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./16.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-c8ad9e5dbd60b7b70b38521ab19b7da4.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-23102fe0f0b5b1a9f09cc09ebcc8fe5b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script><script async="" src="https://www.googletagmanager.com/gtag/js?id=G-GFR4ZDG7V6"></script><script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
 
  gtag('consent', 'default', {
    'ad_storage': 'denied',
    'analytics_storage': 'denied'
  });
gtag('config', 'G-GFR4ZDG7V6', { 'anonymize_ip': true});
</script><script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script><script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script><script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>
</head>
<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./17.html"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Spatial econometrics models</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Spatial Data Science</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/edzer/sdsr_exercises/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spatial Data Science, with applications in R</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Intro</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Coordinates</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Geometries</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Spherical geometry</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Attributes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Data Cubes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">sf, stars</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Plotting</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Large datasets</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Statistical models for spatial data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./11.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Spatial Point Patterns</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./12.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">12</span>&nbsp; <span class="chapter-title">Spatial Interpolation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./13.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">13</span>&nbsp; <span class="chapter-title">Multivariate and Spatiotemporal Geostatistics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./14.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">14</span>&nbsp; <span class="chapter-title">Proximity and Areal Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./15.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">15</span>&nbsp; <span class="chapter-title">Measures of spatial autocorrelation</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Spatial Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Spatial econometrics models</span></span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">Table of contents</h2>
   
  <ul>
<li><a href="#exercise-17.1" id="toc-exercise-17.1" class="nav-link active" data-scroll-target="#exercise-17.1">Exercise 17.1</a></li>
  <li><a href="#exercise-17.2" id="toc-exercise-17.2" class="nav-link" data-scroll-target="#exercise-17.2">Exercise 17.2</a></li>
  <li><a href="#exercise-17.3" id="toc-exercise-17.3" class="nav-link" data-scroll-target="#exercise-17.3">Exercise 17.3</a></li>
  <li><a href="#exercise-17.4" id="toc-exercise-17.4" class="nav-link" data-scroll-target="#exercise-17.4">Exercise 17.4</a></li>
  <li><a href="#exercise-17.5" id="toc-exercise-17.5" class="nav-link" data-scroll-target="#exercise-17.5">Exercise 17.5</a></li>
  </ul><div class="toc-actions"><ul><li><a href="https://github.com/edzer/sdsr_exercises/edit/main/17.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<h1 class="title">
<span class="chapter-number">17</span>&nbsp; <span class="chapter-title">Spatial econometrics models</span>
</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/load.html">load</a></span><span class="op">(</span><span class="st">"data/ch16.RData"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/">spdep</a></span><span class="op">)</span></span>
<span><span class="co"># Loading required package: spData</span></span>
<span><span class="co"># To access larger datasets in this package, install the</span></span>
<span><span class="co"># spDataLarge package with: `install.packages('spDataLarge',</span></span>
<span><span class="co"># repos='https://nowosad.github.io/drat/', type='source')`</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Attaching package: 'spData'</span></span>
<span><span class="co"># The following object is masked _by_ '.GlobalEnv':</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#     depmunic</span></span>
<span><span class="co"># Loading required package: sf</span></span>
<span><span class="co"># Linking to GEOS 3.12.1, GDAL 3.8.4, PROJ 9.4.0; sf_use_s2() is TRUE</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="exercise-17.1" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="exercise-17.1">Exercise 17.1</h2>
<p>First create a spatial weights object from the <code>k=4</code> symmetrized neighbour object:</p>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spatialreg/">spatialreg</a></span><span class="op">)</span></span>
<span><span class="co"># Loading required package: Matrix</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Attaching package: 'spatialreg'</span></span>
<span><span class="co"># The following objects are masked from 'package:spdep':</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#     get.ClusterOption, get.coresOption, get.mcOption,</span></span>
<span><span class="co">#     get.VerboseOption, get.ZeroPolicyOption,</span></span>
<span><span class="co">#     set.ClusterOption, set.coresOption, set.mcOption,</span></span>
<span><span class="co">#     set.VerboseOption, set.ZeroPolicyOption</span></span>
<span><span class="va">lw</span> <span class="op">&lt;-</span> <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/nb2listw.html">nb2listw</a></span><span class="op">(</span><span class="va">pr_nb_k4s</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Fit a linear model to the lower-level data; all the included variables seem worth retaining:</p>
<div class="cell">
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">LM_pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">f_pr</span>, data<span class="op">=</span><span class="va">properties_in_dd</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">LM_pr</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co"># lm(formula = f_pr, data = properties_in_dd)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residuals:</span></span>
<span><span class="co">#     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co"># -5691.2  -456.7  -202.2   251.9  6872.9 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Coefficients:</span></span>
<span><span class="co">#               Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co"># (Intercept) 1702.61693   78.59752   21.66  &lt; 2e-16 ***</span></span>
<span><span class="co"># size           5.18681    0.46510   11.15  &lt; 2e-16 ***</span></span>
<span><span class="co"># age          -18.11938    1.33737  -13.55  &lt; 2e-16 ***</span></span>
<span><span class="co"># dist_metro    -0.32446    0.07115   -4.56 5.75e-06 ***</span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residual standard error: 792.2 on 996 degrees of freedom</span></span>
<span><span class="co"># Multiple R-squared:  0.2368,  Adjusted R-squared:  0.2345 </span></span>
<span><span class="co"># F-statistic:   103 on 3 and 996 DF,  p-value: &lt; 2.2e-16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>However, there is strong residual autocorrelation:</p>
<div class="cell">
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/">spdep</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.morantest.html">lm.morantest</a></span><span class="op">(</span><span class="va">LM_pr</span>, <span class="va">lw</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Global Moran I for regression residuals</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(formula = f_pr, data = properties_in_dd)</span></span>
<span><span class="co"># weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Moran I statistic standard deviate = 26.039, p-value &lt;</span></span>
<span><span class="co"># 2.2e-16</span></span>
<span><span class="co"># alternative hypothesis: greater</span></span>
<span><span class="co"># sample estimates:</span></span>
<span><span class="co"># Observed Moran I      Expectation         Variance </span></span>
<span><span class="co">#     0.4872794374    -0.0023026155     0.0003535235</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Robust (adjusted) Lagrange multiplier tests (Rao’s score tests) suggest that the fitted model should include a spatial autoregressive process in the residuals, but not in the response:</p>
<div class="cell">
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html">packageVersion</a></span><span class="op">(</span><span class="st">"spdep"</span><span class="op">)</span> <span class="op">&lt;</span> <span class="st">"1.3.3"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.RStests.html">lm.LMtests</a></span><span class="op">(</span><span class="va">LM_pr</span>, <span class="va">lw</span>, test<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"RLMerr"</span>, <span class="st">"RLMlag"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.RStests.html">lm.RStests</a></span><span class="op">(</span><span class="va">LM_pr</span>, <span class="va">lw</span>, test<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"adjRSerr"</span>, <span class="st">"adjRSlag"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Rao's score (a.k.a Lagrange multiplier) diagnostics for</span></span>
<span><span class="co">#   spatial dependence</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(formula = f_pr, data = properties_in_dd)</span></span>
<span><span class="co"># test weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># adjRSerr = 150.88, df = 1, p-value &lt; 2.2e-16</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Rao's score (a.k.a Lagrange multiplier) diagnostics for</span></span>
<span><span class="co">#   spatial dependence</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(formula = f_pr, data = properties_in_dd)</span></span>
<span><span class="co"># test weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># adjRSlag = 1.2688, df = 1, p-value = 0.26</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Adding in the copied out municipality department level variables, we see that they do not seem to be worth retaining (unless there are good reasons for doing so); they do however improve model fit:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">LM_pr_md</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="va">f_pr_md</span>, data<span class="op">=</span><span class="va">properties_in_dd</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">LM_pr_md</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co"># lm(formula = f_pr_md, data = properties_in_dd)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residuals:</span></span>
<span><span class="co">#     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co"># -5175.9  -371.6  -107.1   266.7  6648.1 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Coefficients:</span></span>
<span><span class="co">#               Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co"># (Intercept) 1648.17176  189.84951   8.681   &lt;2e-16 ***</span></span>
<span><span class="co"># size           4.29551    0.43386   9.901   &lt;2e-16 ***</span></span>
<span><span class="co"># age          -20.18585    1.27009 -15.893   &lt;2e-16 ***</span></span>
<span><span class="co"># dist_metro    -0.15180    0.07159  -2.120   0.0342 *  </span></span>
<span><span class="co"># foreigners   -38.13473   22.54311  -1.692   0.0910 .  </span></span>
<span><span class="co"># prgreensp     23.90080   16.33291   1.463   0.1437    </span></span>
<span><span class="co"># popdens      -51.82590  103.65578  -0.500   0.6172    </span></span>
<span><span class="co"># museums      -19.06125   21.27904  -0.896   0.3706    </span></span>
<span><span class="co"># airbnb         0.63284    0.32887   1.924   0.0546 .  </span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residual standard error: 727.6 on 991 degrees of freedom</span></span>
<span><span class="co"># Multiple R-squared:  0.3596,  Adjusted R-squared:  0.3544 </span></span>
<span><span class="co"># F-statistic: 69.55 on 8 and 991 DF,  p-value: &lt; 2.2e-16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The pre-test results are similar to those for the properties-only variables:</p>
<div class="cell">
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.morantest.html">lm.morantest</a></span><span class="op">(</span><span class="va">LM_pr_md</span>, <span class="va">lw</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Global Moran I for regression residuals</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(formula = f_pr_md, data = properties_in_dd)</span></span>
<span><span class="co"># weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Moran I statistic standard deviate = 23.707, p-value &lt;</span></span>
<span><span class="co"># 2.2e-16</span></span>
<span><span class="co"># alternative hypothesis: greater</span></span>
<span><span class="co"># sample estimates:</span></span>
<span><span class="co"># Observed Moran I      Expectation         Variance </span></span>
<span><span class="co">#     0.4307327715    -0.0070398073     0.0003410046</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and the LM tests continue to indicate an omitted spatial process in the residual rather than the response:</p>
<div class="cell">
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html">packageVersion</a></span><span class="op">(</span><span class="st">"spdep"</span><span class="op">)</span> <span class="op">&lt;</span> <span class="st">"1.3.3"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.RStests.html">lm.LMtests</a></span><span class="op">(</span><span class="va">LM_pr_md</span>, <span class="va">lw</span>, test<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"RLMerr"</span>, <span class="st">"RLMlag"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.RStests.html">lm.RStests</a></span><span class="op">(</span><span class="va">LM_pr_md</span>, <span class="va">lw</span>, test<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"adjRSerr"</span>, <span class="st">"adjRSlag"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Rao's score (a.k.a Lagrange multiplier) diagnostics for</span></span>
<span><span class="co">#   spatial dependence</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(formula = f_pr_md, data = properties_in_dd)</span></span>
<span><span class="co"># test weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># adjRSerr = 116.67, df = 1, p-value &lt; 2.2e-16</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Rao's score (a.k.a Lagrange multiplier) diagnostics for</span></span>
<span><span class="co">#   spatial dependence</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(formula = f_pr_md, data = properties_in_dd)</span></span>
<span><span class="co"># test weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># adjRSlag = 0.0035207, df = 1, p-value = 0.9527</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="exercise-17.2" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="exercise-17.2">Exercise 17.2</h2>
<p>We may update the formula for the properties-only model to include municipality department “fixed effects”, dummy variables:</p>
<div class="cell">
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">LM_pr_fx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">f_pr</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="va">num_dep</span><span class="op">)</span>, data<span class="op">=</span><span class="va">properties_in_dd</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">LM_pr_fx</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co"># lm(formula = update(f_pr, . ~ . + num_dep), data = properties_in_dd)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residuals:</span></span>
<span><span class="co">#     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co"># -5175.3  -377.2   -97.9   272.7  6644.6 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Coefficients:</span></span>
<span><span class="co">#               Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co"># (Intercept)  2.352e+03  9.816e+01  23.964  &lt; 2e-16 ***</span></span>
<span><span class="co"># size         4.295e+00  4.330e-01   9.919  &lt; 2e-16 ***</span></span>
<span><span class="co"># age         -2.007e+01  1.269e+00 -15.819  &lt; 2e-16 ***</span></span>
<span><span class="co"># dist_metro  -1.442e-01  7.154e-02  -2.015 0.044176 *  </span></span>
<span><span class="co"># num_dep2    -3.342e+02  8.695e+01  -3.844 0.000129 ***</span></span>
<span><span class="co"># num_dep3    -4.896e+02  1.290e+02  -3.794 0.000157 ***</span></span>
<span><span class="co"># num_dep4    -1.031e+03  1.193e+02  -8.641  &lt; 2e-16 ***</span></span>
<span><span class="co"># num_dep5    -8.222e+02  8.251e+01  -9.964  &lt; 2e-16 ***</span></span>
<span><span class="co"># num_dep6    -9.183e+02  7.861e+01 -11.681  &lt; 2e-16 ***</span></span>
<span><span class="co"># num_dep7    -6.527e+02  8.250e+01  -7.911 6.78e-15 ***</span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residual standard error: 726.2 on 990 degrees of freedom</span></span>
<span><span class="co"># Multiple R-squared:  0.3627,  Adjusted R-squared:  0.3569 </span></span>
<span><span class="co"># F-statistic:  62.6 on 9 and 990 DF,  p-value: &lt; 2.2e-16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The pre-test output is similar to that for the models considered above:</p>
<div class="cell">
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.morantest.html">lm.morantest</a></span><span class="op">(</span><span class="va">LM_pr_fx</span>, <span class="va">lw</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Global Moran I for regression residuals</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(formula = update(f_pr, . ~ . + num_dep), data =</span></span>
<span><span class="co"># properties_in_dd)</span></span>
<span><span class="co"># weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Moran I statistic standard deviate = 23.611, p-value &lt;</span></span>
<span><span class="co"># 2.2e-16</span></span>
<span><span class="co"># alternative hypothesis: greater</span></span>
<span><span class="co"># sample estimates:</span></span>
<span><span class="co"># Observed Moran I      Expectation         Variance </span></span>
<span><span class="co">#     0.4268054149    -0.0079765936     0.0003390813</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html">packageVersion</a></span><span class="op">(</span><span class="st">"spdep"</span><span class="op">)</span> <span class="op">&lt;</span> <span class="st">"1.3.3"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.RStests.html">lm.LMtests</a></span><span class="op">(</span><span class="va">LM_pr_fx</span>, <span class="va">lw</span>, test<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"RLMerr"</span>, <span class="st">"RLMlag"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.RStests.html">lm.RStests</a></span><span class="op">(</span><span class="va">LM_pr_fx</span>, <span class="va">lw</span>, test<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"adjRSerr"</span>, <span class="st">"adjRSlag"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Rao's score (a.k.a Lagrange multiplier) diagnostics for</span></span>
<span><span class="co">#   spatial dependence</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(formula = update(f_pr, . ~ . + num_dep), data =</span></span>
<span><span class="co"># properties_in_dd)</span></span>
<span><span class="co"># test weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># adjRSerr = 117.99, df = 1, p-value &lt; 2.2e-16</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Rao's score (a.k.a Lagrange multiplier) diagnostics for</span></span>
<span><span class="co">#   spatial dependence</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(formula = update(f_pr, . ~ . + num_dep), data =</span></span>
<span><span class="co"># properties_in_dd)</span></span>
<span><span class="co"># test weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># adjRSlag = 0.030669, df = 1, p-value = 0.861</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We may fit a regimes model, where separate regression coefficients are calculated for interactions between the municipality department dummies and the included variables; <code>size</code> and <code>dist_metro</code> only retian influence for municipality departments 1 and 2:</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">LM_pr_reg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html">lm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/update.html">update</a></span><span class="op">(</span><span class="va">f_pr</span>, <span class="va">.</span> <span class="op">~</span> <span class="va">num_dep</span><span class="op">/</span><span class="op">(</span><span class="fl">0</span> <span class="op">+</span> <span class="va">.</span><span class="op">)</span><span class="op">)</span>, data<span class="op">=</span><span class="va">properties_in_dd</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">LM_pr_reg</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co"># lm(formula = update(f_pr, . ~ num_dep/(0 + .)), data = properties_in_dd)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residuals:</span></span>
<span><span class="co">#     Min      1Q  Median      3Q     Max </span></span>
<span><span class="co"># -2055.0  -328.6   -62.8   257.2  6353.5 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Coefficients:</span></span>
<span><span class="co">#                       Estimate Std. Error t value Pr(&gt;|t|)    </span></span>
<span><span class="co"># num_dep1            2366.55794  206.45952  11.463  &lt; 2e-16 ***</span></span>
<span><span class="co"># num_dep2            1114.08697  167.84304   6.638 5.29e-11 ***</span></span>
<span><span class="co"># num_dep3            2095.07546  424.99044   4.930 9.68e-07 ***</span></span>
<span><span class="co"># num_dep4            1351.29266  465.10378   2.905 0.003752 ** </span></span>
<span><span class="co"># num_dep5            1695.64352  234.29757   7.237 9.30e-13 ***</span></span>
<span><span class="co"># num_dep6            1611.35873  167.16126   9.640  &lt; 2e-16 ***</span></span>
<span><span class="co"># num_dep7            1705.22449  176.18849   9.678  &lt; 2e-16 ***</span></span>
<span><span class="co"># num_dep1:size          1.36164    0.51169   2.661 0.007918 ** </span></span>
<span><span class="co"># num_dep2:size         14.62370    0.99848  14.646  &lt; 2e-16 ***</span></span>
<span><span class="co"># num_dep3:size          2.25680    4.50973   0.500 0.616886    </span></span>
<span><span class="co"># num_dep4:size          3.79360    4.56205   0.832 0.405864    </span></span>
<span><span class="co"># num_dep5:size          3.06546    1.93716   1.582 0.113872    </span></span>
<span><span class="co"># num_dep6:size          1.49313    1.33800   1.116 0.264724    </span></span>
<span><span class="co"># num_dep7:size          5.91935    1.37694   4.299 1.89e-05 ***</span></span>
<span><span class="co"># num_dep1:age          -6.83169    3.55084  -1.924 0.054651 .  </span></span>
<span><span class="co"># num_dep2:age          -9.36978    3.07762  -3.044 0.002393 ** </span></span>
<span><span class="co"># num_dep3:age         -18.07526    5.65924  -3.194 0.001449 ** </span></span>
<span><span class="co"># num_dep4:age         -22.43736    5.03824  -4.453 9.43e-06 ***</span></span>
<span><span class="co"># num_dep5:age         -27.07143    2.71096  -9.986  &lt; 2e-16 ***</span></span>
<span><span class="co"># num_dep6:age         -23.33611    2.34894  -9.935  &lt; 2e-16 ***</span></span>
<span><span class="co"># num_dep7:age         -24.34731    2.65955  -9.155  &lt; 2e-16 ***</span></span>
<span><span class="co"># num_dep1:dist_metro   -0.72509    0.21429  -3.384 0.000744 ***</span></span>
<span><span class="co"># num_dep2:dist_metro   -0.61219    0.17457  -3.507 0.000474 ***</span></span>
<span><span class="co"># num_dep3:dist_metro   -0.56261    0.52693  -1.068 0.285918    </span></span>
<span><span class="co"># num_dep4:dist_metro    0.02032    0.43294   0.047 0.962570    </span></span>
<span><span class="co"># num_dep5:dist_metro    0.10681    0.29026   0.368 0.712965    </span></span>
<span><span class="co"># num_dep6:dist_metro    0.05074    0.09829   0.516 0.605810    </span></span>
<span><span class="co"># num_dep7:dist_metro   -0.14110    0.14727  -0.958 0.338274    </span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residual standard error: 663.8 on 972 degrees of freedom</span></span>
<span><span class="co"># Multiple R-squared:  0.8323,  Adjusted R-squared:  0.8274 </span></span>
<span><span class="co"># F-statistic: 172.2 on 28 and 972 DF,  p-value: &lt; 2.2e-16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The pre-test results are now changed, with possible spatial processes in both residuals and response being indicated:</p>
<div class="cell">
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.morantest.html">lm.morantest</a></span><span class="op">(</span><span class="va">LM_pr_reg</span>, <span class="va">lw</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Global Moran I for regression residuals</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(formula = update(f_pr, . ~ num_dep/(0 + .)), data</span></span>
<span><span class="co"># = properties_in_dd)</span></span>
<span><span class="co"># weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Moran I statistic standard deviate = 18.521, p-value &lt;</span></span>
<span><span class="co"># 2.2e-16</span></span>
<span><span class="co"># alternative hypothesis: greater</span></span>
<span><span class="co"># sample estimates:</span></span>
<span><span class="co"># Observed Moran I      Expectation         Variance </span></span>
<span><span class="co">#     0.3198250101    -0.0139390950     0.0003247394</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html">packageVersion</a></span><span class="op">(</span><span class="st">"spdep"</span><span class="op">)</span> <span class="op">&lt;</span> <span class="st">"1.3.3"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.RStests.html">lm.LMtests</a></span><span class="op">(</span><span class="va">LM_pr_reg</span>, <span class="va">lw</span>, test<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"RLMerr"</span>, <span class="st">"RLMlag"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.RStests.html">lm.RStests</a></span><span class="op">(</span><span class="va">LM_pr_reg</span>, <span class="va">lw</span>, test<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"adjRSerr"</span>, <span class="st">"adjRSlag"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Rao's score (a.k.a Lagrange multiplier) diagnostics for</span></span>
<span><span class="co">#   spatial dependence</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(formula = update(f_pr, . ~ num_dep/(0 + .)), data</span></span>
<span><span class="co"># = properties_in_dd)</span></span>
<span><span class="co"># test weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># adjRSerr = 40.873, df = 1, p-value = 1.625e-10</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Rao's score (a.k.a Lagrange multiplier) diagnostics for</span></span>
<span><span class="co">#   spatial dependence</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(formula = update(f_pr, . ~ num_dep/(0 + .)), data</span></span>
<span><span class="co"># = properties_in_dd)</span></span>
<span><span class="co"># test weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># adjRSlag = 19.055, df = 1, p-value = 1.27e-05</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="exercise-17.3" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="exercise-17.3">Exercise 17.3</h2>
<p>Fitting models initially by maximum likelihood (GMM may also be used), we pre-compute the eigenvalues:</p>
<div class="cell">
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">eigs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/eigenw.html">eigenw</a></span><span class="op">(</span><span class="va">lw</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The strong residual autocorrelation is picked up by the spatial coefficient, but unfortunately the Hausman test shows strong mis-specification:</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">SEM_pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/ML_models.html">errorsarlm</a></span><span class="op">(</span><span class="va">f_pr</span>, data<span class="op">=</span><span class="va">properties_in_dd</span>, listw<span class="op">=</span><span class="va">lw</span>, Durbin<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>    control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pre_eig<span class="op">=</span><span class="va">eigs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">SEM_pr</span>, Hausman<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co"># errorsarlm(formula = f_pr, data = properties_in_dd, listw = lw, </span></span>
<span><span class="co">#     Durbin = FALSE, control = list(pre_eig = eigs))</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residuals:</span></span>
<span><span class="co">#       Min        1Q    Median        3Q       Max </span></span>
<span><span class="co"># -3214.225  -337.719   -75.561   196.920  5411.793 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Type: error </span></span>
<span><span class="co"># Coefficients: (asymptotic standard errors) </span></span>
<span><span class="co">#               Estimate Std. Error  z value Pr(&gt;|z|)</span></span>
<span><span class="co"># (Intercept) 1999.09195  120.70304  16.5621  &lt; 2e-16</span></span>
<span><span class="co"># size           3.21092    0.35840   8.9591  &lt; 2e-16</span></span>
<span><span class="co"># age          -23.64759    1.06426 -22.2199  &lt; 2e-16</span></span>
<span><span class="co"># dist_metro    -0.27302    0.14694  -1.8581  0.06315</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Lambda: 0.6927, LR test value: 459.76, p-value: &lt; 2.22e-16</span></span>
<span><span class="co"># Asymptotic standard error: 0.024179</span></span>
<span><span class="co">#     z-value: 28.649, p-value: &lt; 2.22e-16</span></span>
<span><span class="co"># Wald statistic: 820.74, p-value: &lt; 2.22e-16</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Log likelihood: -7861.931 for error model</span></span>
<span><span class="co"># ML residual variance (sigma squared): 354240, (sigma: 595.18)</span></span>
<span><span class="co"># Number of observations: 1000 </span></span>
<span><span class="co"># Number of parameters estimated: 6 </span></span>
<span><span class="co"># AIC: 15736, (AIC for lm: 16194)</span></span>
<span><span class="co"># Hausman test: -246.29, df: 4, p-value: &lt; 2.22e-16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The Hausman test compares the OLS and SEM coefficient estimates and their standard errors, assessing whether their distributions overlap sufficiently to suggest the absence of major mis-specification:</p>
<div class="cell">
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">LM_coefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">LM_pr</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#                 Estimate  Std. Error    t value     Pr(&gt;|t|)</span></span>
<span><span class="co"># (Intercept) 1702.6169273 78.59752134  21.662476 1.432984e-85</span></span>
<span><span class="co"># size           5.1868075  0.46509907  11.152049 2.679763e-27</span></span>
<span><span class="co"># age          -18.1193826  1.33737467 -13.548472 1.662323e-38</span></span>
<span><span class="co"># dist_metro    -0.3244594  0.07115232  -4.560068 5.749564e-06</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="op">(</span><span class="va">SEM_coefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">SEM_pr</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#                 Estimate  Std. Error    z value   Pr(&gt;|z|)</span></span>
<span><span class="co"># (Intercept) 1999.0919533 120.7030383  16.562068 0.00000000</span></span>
<span><span class="co"># size           3.2109209   0.3583989   8.959070 0.00000000</span></span>
<span><span class="co"># age          -23.6475914   1.0642551 -22.219853 0.00000000</span></span>
<span><span class="co"># dist_metro    -0.2730235   0.1469362  -1.858109 0.06315359</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The tables are harder to read than the figure, which shows that the coefficient estimates do differ a lot for two variables, somewhat for the intercept, and little for one variable, but where the ML standard error estimate under usual assumptions crosses zero:</p>
<div class="cell">
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">opar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fl">1</span>, type<span class="op">=</span><span class="st">"n"</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1400</span>, <span class="fl">2500</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.006</span><span class="op">)</span>, xlab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">LM_coefs</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, ylab<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, mean<span class="op">=</span><span class="va">LM_coefs</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>, sd<span class="op">=</span><span class="va">LM_coefs</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>, add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">LM_coefs</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">SEM_coefs</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">"orange"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, mean<span class="op">=</span><span class="va">SEM_coefs</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">]</span>, sd<span class="op">=</span><span class="va">SEM_coefs</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>, add<span class="op">=</span><span class="cn">TRUE</span>, col<span class="op">=</span><span class="st">"orange"</span>, lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html">legend</a></span><span class="op">(</span><span class="st">"topright"</span>, legend<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"LM"</span>, <span class="st">"SEM"</span><span class="op">)</span>, col<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"orange"</span><span class="op">)</span>, lwd<span class="op">=</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, bty<span class="op">=</span><span class="st">"n"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fl">1</span>, type<span class="op">=</span><span class="st">"n"</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1.5</span>, <span class="fl">7</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1.1</span><span class="op">)</span>, xlab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">LM_coefs</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, ylab<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, mean<span class="op">=</span><span class="va">LM_coefs</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span>, sd<span class="op">=</span><span class="va">LM_coefs</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>, add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">LM_coefs</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">SEM_coefs</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">"orange"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, mean<span class="op">=</span><span class="va">SEM_coefs</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span>, sd<span class="op">=</span><span class="va">SEM_coefs</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>, add<span class="op">=</span><span class="cn">TRUE</span>, col<span class="op">=</span><span class="st">"orange"</span>, lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fl">1</span>, type<span class="op">=</span><span class="st">"n"</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">28</span>, <span class="op">-</span><span class="fl">13</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.4</span><span class="op">)</span>, xlab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">LM_coefs</span><span class="op">)</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span>, ylab<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, mean<span class="op">=</span><span class="va">LM_coefs</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span>, sd<span class="op">=</span><span class="va">LM_coefs</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>, add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">LM_coefs</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">SEM_coefs</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">"orange"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, mean<span class="op">=</span><span class="va">SEM_coefs</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">1</span><span class="op">]</span>, sd<span class="op">=</span><span class="va">SEM_coefs</span><span class="op">[</span><span class="fl">3</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>, add<span class="op">=</span><span class="cn">TRUE</span>, col<span class="op">=</span><span class="st">"orange"</span>, lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html">plot</a></span><span class="op">(</span><span class="fl">1</span>, type<span class="op">=</span><span class="st">"n"</span>, xlim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.9</span>, <span class="fl">0.3</span><span class="op">)</span>, ylim<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">6</span><span class="op">)</span>, xlab<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html">rownames</a></span><span class="op">(</span><span class="va">LM_coefs</span><span class="op">)</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span>, ylab<span class="op">=</span><span class="st">""</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, mean<span class="op">=</span><span class="va">LM_coefs</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">1</span><span class="op">]</span>, sd<span class="op">=</span><span class="va">LM_coefs</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>, add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">LM_coefs</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html">abline</a></span><span class="op">(</span>v<span class="op">=</span><span class="va">SEM_coefs</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">1</span><span class="op">]</span>, lwd<span class="op">=</span><span class="fl">2</span>, col<span class="op">=</span><span class="st">"orange"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/curve.html">curve</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html">dnorm</a></span><span class="op">(</span><span class="va">x</span>, mean<span class="op">=</span><span class="va">SEM_coefs</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">1</span><span class="op">]</span>, sd<span class="op">=</span><span class="va">SEM_coefs</span><span class="op">[</span><span class="fl">4</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span>, add<span class="op">=</span><span class="cn">TRUE</span>, col<span class="op">=</span><span class="st">"orange"</span>, lwd<span class="op">=</span><span class="fl">2</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="17_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span><span class="va">opar</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The Hausman test also suggests mis-specification for the SEM model augmented with the municipality department level variables:</p>
<div class="cell">
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">SEM_pr_md</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/ML_models.html">errorsarlm</a></span><span class="op">(</span><span class="va">f_pr_md</span>, data<span class="op">=</span><span class="va">properties_in_dd</span>, listw<span class="op">=</span><span class="va">lw</span>, Durbin<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>    control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pre_eig<span class="op">=</span><span class="va">eigs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">SEM_pr_md</span>, Hausman<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Call:</span></span>
<span><span class="co"># errorsarlm(formula = f_pr_md, data = properties_in_dd, listw = lw, </span></span>
<span><span class="co">#     Durbin = FALSE, control = list(pre_eig = eigs))</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Residuals:</span></span>
<span><span class="co">#       Min        1Q    Median        3Q       Max </span></span>
<span><span class="co"># -3421.923  -320.793   -65.301   224.785  5452.101 </span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Type: error </span></span>
<span><span class="co"># Coefficients: (asymptotic standard errors) </span></span>
<span><span class="co">#               Estimate Std. Error  z value  Pr(&gt;|z|)</span></span>
<span><span class="co"># (Intercept) 1945.79328  333.00264   5.8432 5.121e-09</span></span>
<span><span class="co"># size           3.05839    0.35711   8.5643 &lt; 2.2e-16</span></span>
<span><span class="co"># age          -23.45168    1.06301 -22.0616 &lt; 2.2e-16</span></span>
<span><span class="co"># dist_metro    -0.14969    0.13214  -1.1328    0.2573</span></span>
<span><span class="co"># foreigners    -7.66310   42.72513  -0.1794    0.8577</span></span>
<span><span class="co"># prgreensp     38.40537   31.36427   1.2245    0.2208</span></span>
<span><span class="co"># popdens     -211.52188  190.49686  -1.1104    0.2668</span></span>
<span><span class="co"># museums      -33.84712   39.33249  -0.8605    0.3895</span></span>
<span><span class="co"># airbnb         0.59183    0.60062   0.9854    0.3244</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Lambda: 0.62414, LR test value: 335.94, p-value: &lt; 2.22e-16</span></span>
<span><span class="co"># Asymptotic standard error: 0.028289</span></span>
<span><span class="co">#     z-value: 22.063, p-value: &lt; 2.22e-16</span></span>
<span><span class="co"># Wald statistic: 486.78, p-value: &lt; 2.22e-16</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Log likelihood: -7836.138 for error model</span></span>
<span><span class="co"># ML residual variance (sigma squared): 345330, (sigma: 587.65)</span></span>
<span><span class="co"># Number of observations: 1000 </span></span>
<span><span class="co"># Number of parameters estimated: 11 </span></span>
<span><span class="co"># AIC: 15694, (AIC for lm: 16028)</span></span>
<span><span class="co"># Hausman test: -1348.4, df: 9, p-value: &lt; 2.22e-16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Extending to the SDEM models, and reporting impacts:</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">SDEM_pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/ML_models.html">errorsarlm</a></span><span class="op">(</span><span class="va">f_pr</span>, data<span class="op">=</span><span class="va">properties_in_dd</span>, listw<span class="op">=</span><span class="va">lw</span>, Durbin<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pre_eig<span class="op">=</span><span class="va">eigs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/impacts.html">impacts</a></span><span class="op">(</span><span class="va">SDEM_pr</span><span class="op">)</span>, short<span class="op">=</span><span class="cn">TRUE</span>, zstats<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Impact measures (SDEM, glht, n):</span></span>
<span><span class="co">#                       Direct   Indirect       Total</span></span>
<span><span class="co"># size dy/dx         3.4445402  2.0126059   5.4571461</span></span>
<span><span class="co"># age dy/dx        -21.9222898 10.9931413 -10.9291485</span></span>
<span><span class="co"># dist_metro dy/dx   0.2000411 -0.5494199  -0.3493789</span></span>
<span><span class="co"># ========================================================</span></span>
<span><span class="co"># Standard errors:</span></span>
<span><span class="co">#                     Direct  Indirect     Total</span></span>
<span><span class="co"># size dy/dx       0.3983375 1.0053504 1.2310345</span></span>
<span><span class="co"># age dy/dx        1.1425638 2.5191829 3.1162005</span></span>
<span><span class="co"># dist_metro dy/dx 0.2734082 0.3104821 0.1551602</span></span>
<span><span class="co"># ========================================================</span></span>
<span><span class="co"># Z-values:</span></span>
<span><span class="co">#                       Direct  Indirect     Total</span></span>
<span><span class="co"># size dy/dx         8.6472910  2.001895  4.432976</span></span>
<span><span class="co"># age dy/dx        -19.1869278  4.363773 -3.507203</span></span>
<span><span class="co"># dist_metro dy/dx   0.7316571 -1.769570 -2.251731</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># p-values:</span></span>
<span><span class="co">#                  Direct  Indirect   Total     </span></span>
<span><span class="co"># size dy/dx       &lt; 2e-16 0.045296   9.2941e-06</span></span>
<span><span class="co"># age dy/dx        &lt; 2e-16 1.2784e-05 0.00045284</span></span>
<span><span class="co"># dist_metro dy/dx 0.46438 0.076799   0.02433930</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>we have Hausman test results still indicating strong mis-specification:</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/sarlm_tests.html">Hausman.test</a></span><span class="op">(</span><span class="va">SDEM_pr</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Spatial Hausman test (asymptotic)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  NULL</span></span>
<span><span class="co"># Hausman test = 53.765, df = 7, p-value = 2.618e-09</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The same applies to the properties variables augmented with the municipality department level variables:</p>
<div class="cell">
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">SDEM_pr_md</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/ML_models.html">errorsarlm</a></span><span class="op">(</span><span class="va">f_pr_md</span>, data<span class="op">=</span><span class="va">properties_in_dd</span>, listw<span class="op">=</span><span class="va">lw</span>, Durbin<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pre_eig<span class="op">=</span><span class="va">eigs</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/impacts.html">impacts</a></span><span class="op">(</span><span class="va">SDEM_pr_md</span><span class="op">)</span>, short<span class="op">=</span><span class="cn">TRUE</span>, zstats<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Impact measures (SDEM, glht, n):</span></span>
<span><span class="co">#                        Direct     Indirect       Total</span></span>
<span><span class="co"># size dy/dx          3.2902832    1.6915620   4.9818452</span></span>
<span><span class="co"># age dy/dx         -22.5877017    7.0789019 -15.5087998</span></span>
<span><span class="co"># dist_metro dy/dx    0.2706259   -0.4643729  -0.1937470</span></span>
<span><span class="co"># foreigners dy/dx  107.6194783 -146.8457507 -39.2262723</span></span>
<span><span class="co"># prgreensp dy/dx    35.3436511  -12.5353722  22.8082789</span></span>
<span><span class="co"># popdens dy/dx    -456.7261551  400.0782007 -56.6479544</span></span>
<span><span class="co"># museums dy/dx      51.9819873  -93.3777549 -41.3957677</span></span>
<span><span class="co"># airbnb dy/dx       -0.8658815    1.7162902   0.8504086</span></span>
<span><span class="co"># ========================================================</span></span>
<span><span class="co"># Standard errors:</span></span>
<span><span class="co">#                       Direct    Indirect       Total</span></span>
<span><span class="co"># size dy/dx         0.3900357   0.9742177   1.1837951</span></span>
<span><span class="co"># age dy/dx          1.1250931   2.5043047   3.0554698</span></span>
<span><span class="co"># dist_metro dy/dx   0.2747535   0.3097415   0.1459340</span></span>
<span><span class="co"># foreigners dy/dx  87.2520058  94.9604408  45.6522579</span></span>
<span><span class="co"># prgreensp dy/dx   74.3147399  79.3194510  33.1282650</span></span>
<span><span class="co"># popdens dy/dx    403.5523978 439.7109635 210.7385732</span></span>
<span><span class="co"># museums dy/dx     85.7152296  93.9719229  43.7578162</span></span>
<span><span class="co"># airbnb dy/dx       1.1452242   1.2862739   0.6730805</span></span>
<span><span class="co"># ========================================================</span></span>
<span><span class="co"># Z-values:</span></span>
<span><span class="co">#                       Direct   Indirect      Total</span></span>
<span><span class="co"># size dy/dx         8.4358515  1.7363285  4.2083678</span></span>
<span><span class="co"># age dy/dx        -20.0762965  2.8266936 -5.0757498</span></span>
<span><span class="co"># dist_metro dy/dx   0.9849770 -1.4992275 -1.3276346</span></span>
<span><span class="co"># foreigners dy/dx   1.2334327 -1.5463887 -0.8592406</span></span>
<span><span class="co"># prgreensp dy/dx    0.4755941 -0.1580365  0.6884840</span></span>
<span><span class="co"># popdens dy/dx     -1.1317642  0.9098663 -0.2688068</span></span>
<span><span class="co"># museums dy/dx      0.6064498 -0.9936772 -0.9460200</span></span>
<span><span class="co"># airbnb dy/dx      -0.7560804  1.3343115  1.2634575</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># p-values:</span></span>
<span><span class="co">#                  Direct  Indirect  Total     </span></span>
<span><span class="co"># size dy/dx       &lt; 2e-16 0.0825058 2.5722e-05</span></span>
<span><span class="co"># age dy/dx        &lt; 2e-16 0.0047031 3.8597e-07</span></span>
<span><span class="co"># dist_metro dy/dx 0.32464 0.1338146 0.18430   </span></span>
<span><span class="co"># foreigners dy/dx 0.21741 0.1220107 0.39021   </span></span>
<span><span class="co"># prgreensp dy/dx  0.63436 0.8744280 0.49115   </span></span>
<span><span class="co"># popdens dy/dx    0.25773 0.3628930 0.78808   </span></span>
<span><span class="co"># museums dy/dx    0.54422 0.3203801 0.34414   </span></span>
<span><span class="co"># airbnb dy/dx     0.44960 0.1821018 0.20642</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/sarlm_tests.html">Hausman.test</a></span><span class="op">(</span><span class="va">SDEM_pr_md</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Spatial Hausman test (asymptotic)</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  NULL</span></span>
<span><span class="co"># Hausman test = 229.24, df = 17, p-value &lt; 2.2e-16</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Reaching out to the SLX models does not help, because although - as with the SDEM models - the indirect impacts (coefficients on lagged <span class="math inline">\(X\)</span> variables) are large, so including lagged <span class="math inline">\(X\)</span> variables especially at the properties level seems sensible, there is serious residual autocorrelation, and now the pre-test strategy points to a missing spatial process in the response:</p>
<div class="cell">
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">SLX_pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/SLX.html">lmSLX</a></span><span class="op">(</span><span class="va">f_pr</span>, data<span class="op">=</span><span class="va">properties_in_dd</span>, listw<span class="op">=</span><span class="va">lw</span>, Durbin<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/impacts.html">impacts</a></span><span class="op">(</span><span class="va">SLX_pr</span><span class="op">)</span>, short<span class="op">=</span><span class="cn">TRUE</span>, zstats<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Impact measures (SlX, glht, n-k):</span></span>
<span><span class="co">#                       Direct   Indirect     Total</span></span>
<span><span class="co"># size dy/dx         3.9424014  6.4922295 10.434631</span></span>
<span><span class="co"># age dy/dx        -22.6778266 13.6377582 -9.040068</span></span>
<span><span class="co"># dist_metro dy/dx   0.5710406 -0.8727816 -0.301741</span></span>
<span><span class="co"># ========================================================</span></span>
<span><span class="co"># Standard errors:</span></span>
<span><span class="co">#                     Direct  Indirect      Total</span></span>
<span><span class="co"># size dy/dx       0.4600099 0.8896271 0.90358915</span></span>
<span><span class="co"># age dy/dx        1.3642232 2.1630220 2.15389898</span></span>
<span><span class="co"># dist_metro dy/dx 0.3650804 0.3766962 0.07031201</span></span>
<span><span class="co"># ========================================================</span></span>
<span><span class="co"># Z-values:</span></span>
<span><span class="co">#                      Direct  Indirect     Total</span></span>
<span><span class="co"># size dy/dx         8.570254  7.297698 11.547982</span></span>
<span><span class="co"># age dy/dx        -16.623252  6.304956 -4.197072</span></span>
<span><span class="co"># dist_metro dy/dx   1.564150 -2.316938 -4.291458</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># p-values:</span></span>
<span><span class="co">#                  Direct  Indirect   Total     </span></span>
<span><span class="co"># size dy/dx       &lt; 2e-16 2.9265e-13 &lt; 2.22e-16</span></span>
<span><span class="co"># age dy/dx        &lt; 2e-16 2.8828e-10 2.7039e-05</span></span>
<span><span class="co"># dist_metro dy/dx 0.11778 0.020507   1.7750e-05</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.morantest.html">lm.morantest</a></span><span class="op">(</span><span class="va">SLX_pr</span>, <span class="va">lw</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Global Moran I for regression residuals</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(formula = formula(paste("y ~ ",</span></span>
<span><span class="co"># paste(colnames(x)[-1], collapse = "+"))), data =</span></span>
<span><span class="co"># as.data.frame(x), weights = weights)</span></span>
<span><span class="co"># weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Moran I statistic standard deviate = 24.275, p-value &lt;</span></span>
<span><span class="co"># 2.2e-16</span></span>
<span><span class="co"># alternative hypothesis: greater</span></span>
<span><span class="co"># sample estimates:</span></span>
<span><span class="co"># Observed Moran I      Expectation         Variance </span></span>
<span><span class="co">#     0.4505572652    -0.0029076149     0.0003489564</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html">packageVersion</a></span><span class="op">(</span><span class="st">"spdep"</span><span class="op">)</span> <span class="op">&lt;</span> <span class="st">"1.3.3"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.RStests.html">lm.LMtests</a></span><span class="op">(</span><span class="va">SLX_pr</span>, <span class="va">lw</span>, test<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"RLMerr"</span>, <span class="st">"RLMlag"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.RStests.html">lm.RStests</a></span><span class="op">(</span><span class="va">SLX_pr</span>, <span class="va">lw</span>, test<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"adjRSerr"</span>, <span class="st">"adjRSlag"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Rao's score (a.k.a Lagrange multiplier) diagnostics for</span></span>
<span><span class="co">#   spatial dependence</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(prpsqm ~ size + age + dist_metro + lag.size +</span></span>
<span><span class="co"># lag.age + lag.dist_metro, data = properties_in_dd, listw =</span></span>
<span><span class="co"># lw)</span></span>
<span><span class="co"># test weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># adjRSerr = 3.9929, df = 1, p-value = 0.04569</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Rao's score (a.k.a Lagrange multiplier) diagnostics for</span></span>
<span><span class="co">#   spatial dependence</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(prpsqm ~ size + age + dist_metro + lag.size +</span></span>
<span><span class="co"># lag.age + lag.dist_metro, data = properties_in_dd, listw =</span></span>
<span><span class="co"># lw)</span></span>
<span><span class="co"># test weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># adjRSlag = 54.185, df = 1, p-value = 1.825e-13</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">SLX_pr_md</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/SLX.html">lmSLX</a></span><span class="op">(</span><span class="va">f_pr_md</span>, data<span class="op">=</span><span class="va">properties_in_dd</span>, listw<span class="op">=</span><span class="va">lw</span>, Durbin<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/impacts.html">impacts</a></span><span class="op">(</span><span class="va">SLX_pr_md</span><span class="op">)</span>, short<span class="op">=</span><span class="cn">TRUE</span>, zstats<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Impact measures (SlX, glht, n-k):</span></span>
<span><span class="co">#                        Direct     Indirect       Total</span></span>
<span><span class="co"># size dy/dx          3.6899279    5.1853598   8.8752878</span></span>
<span><span class="co"># age dy/dx         -22.4862582    7.7433691 -14.7428891</span></span>
<span><span class="co"># dist_metro dy/dx    0.4883417   -0.6216376  -0.1332958</span></span>
<span><span class="co"># foreigners dy/dx  111.8693211 -144.2912677 -32.4219466</span></span>
<span><span class="co"># prgreensp dy/dx    -7.9374540   33.7296361  25.7921821</span></span>
<span><span class="co"># popdens dy/dx    -175.9679694   76.3367323 -99.6312371</span></span>
<span><span class="co"># museums dy/dx     132.9274926 -150.5428303 -17.6153377</span></span>
<span><span class="co"># airbnb dy/dx       -1.6203107    2.0992718   0.4789610</span></span>
<span><span class="co"># ========================================================</span></span>
<span><span class="co"># Standard errors:</span></span>
<span><span class="co">#                       Direct    Indirect        Total</span></span>
<span><span class="co"># size dy/dx         0.4374870   0.8640075   0.88540694</span></span>
<span><span class="co"># age dy/dx          1.2999436   2.1706052   2.20258646</span></span>
<span><span class="co"># dist_metro dy/dx   0.3469593   0.3606514   0.07353124</span></span>
<span><span class="co"># foreigners dy/dx 113.3256387 115.6423334  22.69480121</span></span>
<span><span class="co"># prgreensp dy/dx   98.1127344  99.5966256  16.36663957</span></span>
<span><span class="co"># popdens dy/dx    521.4661878 532.2960996 105.63203070</span></span>
<span><span class="co"># museums dy/dx    115.4990904 118.1243717  21.60621836</span></span>
<span><span class="co"># airbnb dy/dx       1.5181784   1.5638933   0.33577968</span></span>
<span><span class="co"># ========================================================</span></span>
<span><span class="co"># Z-values:</span></span>
<span><span class="co">#                        Direct   Indirect      Total</span></span>
<span><span class="co"># size dy/dx         8.43437158  6.0015219 10.0239645</span></span>
<span><span class="co"># age dy/dx        -17.29787276  3.5673779 -6.6934440</span></span>
<span><span class="co"># dist_metro dy/dx   1.40748996 -1.7236520 -1.8127784</span></span>
<span><span class="co"># foreigners dy/dx   0.98714927 -1.2477374 -1.4286068</span></span>
<span><span class="co"># prgreensp dy/dx   -0.08090136  0.3386624  1.5758997</span></span>
<span><span class="co"># popdens dy/dx     -0.33744847  0.1434103 -0.9431915</span></span>
<span><span class="co"># museums dy/dx      1.15089645 -1.2744434 -0.8152902</span></span>
<span><span class="co"># airbnb dy/dx      -1.06727292  1.3423369  1.4264145</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># p-values:</span></span>
<span><span class="co">#                  Direct  Indirect   Total     </span></span>
<span><span class="co"># size dy/dx       &lt; 2e-16 1.9548e-09 &lt; 2.22e-16</span></span>
<span><span class="co"># age dy/dx        &lt; 2e-16 0.00036057 2.1798e-11</span></span>
<span><span class="co"># dist_metro dy/dx 0.15928 0.08477068 0.069866  </span></span>
<span><span class="co"># foreigners dy/dx 0.32357 0.21212723 0.153117  </span></span>
<span><span class="co"># prgreensp dy/dx  0.93552 0.73486404 0.115049  </span></span>
<span><span class="co"># popdens dy/dx    0.73578 0.88596617 0.345583  </span></span>
<span><span class="co"># museums dy/dx    0.24977 0.20250631 0.414906  </span></span>
<span><span class="co"># airbnb dy/dx     0.28585 0.17948677 0.153749</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.morantest.html">lm.morantest</a></span><span class="op">(</span><span class="va">SLX_pr_md</span>, <span class="va">lw</span><span class="op">)</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Global Moran I for regression residuals</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(formula = formula(paste("y ~ ",</span></span>
<span><span class="co"># paste(colnames(x)[-1], collapse = "+"))), data =</span></span>
<span><span class="co"># as.data.frame(x), weights = weights)</span></span>
<span><span class="co"># weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Moran I statistic standard deviate = 22.047, p-value &lt;</span></span>
<span><span class="co"># 2.2e-16</span></span>
<span><span class="co"># alternative hypothesis: greater</span></span>
<span><span class="co"># sample estimates:</span></span>
<span><span class="co"># Observed Moran I      Expectation         Variance </span></span>
<span><span class="co">#     0.3978202243    -0.0070160067     0.0003371825</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html">packageVersion</a></span><span class="op">(</span><span class="st">"spdep"</span><span class="op">)</span> <span class="op">&lt;</span> <span class="st">"1.3.3"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.RStests.html">lm.LMtests</a></span><span class="op">(</span><span class="va">SLX_pr_md</span>, <span class="va">lw</span>, test<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"RLMerr"</span>, <span class="st">"RLMlag"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu">spdep</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/spdep/reference/lm.RStests.html">lm.RStests</a></span><span class="op">(</span><span class="va">SLX_pr_md</span>, <span class="va">lw</span>, test<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"adjRSerr"</span>, <span class="st">"adjRSlag"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Rao's score (a.k.a Lagrange multiplier) diagnostics for</span></span>
<span><span class="co">#   spatial dependence</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(prpsqm ~ size + age + dist_metro + foreigners +</span></span>
<span><span class="co"># prgreensp + popdens + museums + airbnb + lag.size + lag.age</span></span>
<span><span class="co"># + lag.dist_metro + lag.foreigners + lag.prgreensp +</span></span>
<span><span class="co"># lag.popdens + lag.museums + lag.airbnb, data =</span></span>
<span><span class="co"># properties_in_dd, listw = lw)</span></span>
<span><span class="co"># test weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># adjRSerr = 15.011, df = 1, p-value = 0.0001069</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># </span></span>
<span><span class="co">#   Rao's score (a.k.a Lagrange multiplier) diagnostics for</span></span>
<span><span class="co">#   spatial dependence</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># data:  </span></span>
<span><span class="co"># model: lm(prpsqm ~ size + age + dist_metro + foreigners +</span></span>
<span><span class="co"># prgreensp + popdens + museums + airbnb + lag.size + lag.age</span></span>
<span><span class="co"># + lag.dist_metro + lag.foreigners + lag.prgreensp +</span></span>
<span><span class="co"># lag.popdens + lag.museums + lag.airbnb, data =</span></span>
<span><span class="co"># properties_in_dd, listw = lw)</span></span>
<span><span class="co"># test weights: lw</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># adjRSlag = 56.758, df = 1, p-value = 4.929e-14</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>So on balance, the pre-test strategy has not worked out too well; it is unclear what is missing in the model.</p>
</section><section id="exercise-17.4" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="exercise-17.4">Exercise 17.4</h2>
<p>Turning to estimating the general nested model first, followed by excluding the Durbin (spatially lagged <span class="math inline">\(X\)</span>) variables, a likelihood ratio test shows that the spatially lagged <span class="math inline">\(X\)</span> variables should be retained in the model:</p>
<div class="cell">
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GNM_pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/ML_models.html">sacsarlm</a></span><span class="op">(</span><span class="va">f_pr</span>, data<span class="op">=</span><span class="va">properties_in_dd</span>, listw<span class="op">=</span><span class="va">lw</span>, Durbin<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pre_eig1<span class="op">=</span><span class="va">eigs</span>, pre_eig2<span class="op">=</span><span class="va">eigs</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">SARAR_pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/ML_models.html">sacsarlm</a></span><span class="op">(</span><span class="va">f_pr</span>, data<span class="op">=</span><span class="va">properties_in_dd</span>, listw<span class="op">=</span><span class="va">lw</span>, </span>
<span>    control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pre_eig1<span class="op">=</span><span class="va">eigs</span>, pre_eig2<span class="op">=</span><span class="va">eigs</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">lmtest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/lrtest.html">lrtest</a></span><span class="op">(</span><span class="va">SARAR_pr</span>, <span class="va">GNM_pr</span><span class="op">)</span></span>
<span><span class="co"># Likelihood ratio test</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Model 1: prpsqm ~ size + age + dist_metro</span></span>
<span><span class="co"># Model 2: prpsqm ~ size + age + dist_metro</span></span>
<span><span class="co">#   #Df  LogLik Df  Chisq Pr(&gt;Chisq)    </span></span>
<span><span class="co"># 1   7 -7814.6                         </span></span>
<span><span class="co"># 2  10 -7783.9  3 61.303  3.096e-13 ***</span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Again using a likelihood ratio test, the GNM model outperforms the SDEM model:</p>
<div class="cell">
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">lmtest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/lrtest.html">lrtest</a></span><span class="op">(</span><span class="va">SDEM_pr</span>, <span class="va">GNM_pr</span><span class="op">)</span></span>
<span><span class="co"># Likelihood ratio test</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Model 1: prpsqm ~ size + age + dist_metro</span></span>
<span><span class="co"># Model 2: prpsqm ~ size + age + dist_metro</span></span>
<span><span class="co">#   #Df  LogLik Df Chisq Pr(&gt;Chisq)    </span></span>
<span><span class="co"># 1   9 -7850.3                        </span></span>
<span><span class="co"># 2  10 -7783.9  1 132.7  &lt; 2.2e-16 ***</span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">SDM_pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/ML_models.html">lagsarlm</a></span><span class="op">(</span><span class="va">f_pr</span>, data<span class="op">=</span><span class="va">properties_in_dd</span>, listw<span class="op">=</span><span class="va">lw</span>, Durbin<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pre_eig<span class="op">=</span><span class="va">eigs</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>as is also the case with the SDM model:</p>
<div class="cell">
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">lmtest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/lrtest.html">lrtest</a></span><span class="op">(</span><span class="va">SDM_pr</span>, <span class="va">GNM_pr</span><span class="op">)</span></span>
<span><span class="co"># Likelihood ratio test</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Model 1: prpsqm ~ size + age + dist_metro</span></span>
<span><span class="co"># Model 2: prpsqm ~ size + age + dist_metro</span></span>
<span><span class="co">#   #Df  LogLik Df  Chisq Pr(&gt;Chisq)    </span></span>
<span><span class="co"># 1   9 -7842.4                         </span></span>
<span><span class="co"># 2  10 -7783.9  1 117.06  &lt; 2.2e-16 ***</span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and the SLX model:</p>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">lmtest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/lrtest.html">lrtest</a></span><span class="op">(</span><span class="va">SLX_pr</span>, <span class="va">GNM_pr</span><span class="op">)</span></span>
<span><span class="co"># Warning in modelUpdate(objects[[i - 1]], objects[[i]]): original</span></span>
<span><span class="co"># model was of class "SlX", updated model is of class "Sarlm"</span></span>
<span><span class="co"># Likelihood ratio test</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Model 1: y ~ size + age + dist_metro + lag.size + lag.age + lag.dist_metro</span></span>
<span><span class="co"># Model 2: prpsqm ~ size + age + dist_metro</span></span>
<span><span class="co">#   #Df  LogLik Df  Chisq Pr(&gt;Chisq)    </span></span>
<span><span class="co"># 1   8 -8040.1                         </span></span>
<span><span class="co"># 2  10 -7783.9  2 512.46  &lt; 2.2e-16 ***</span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Is the inclusion of the municipality department level variables in the GNM model justified?</p>
<div class="cell">
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GNM_pr_md</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/ML_models.html">sacsarlm</a></span><span class="op">(</span><span class="va">f_pr_md</span>, data<span class="op">=</span><span class="va">properties_in_dd</span>, listw<span class="op">=</span><span class="va">lw</span>, Durbin<span class="op">=</span><span class="cn">TRUE</span>,</span>
<span>    control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pre_eig1<span class="op">=</span><span class="va">eigs</span>, pre_eig2<span class="op">=</span><span class="va">eigs</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>No, not really:</p>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">lmtest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/lrtest.html">lrtest</a></span><span class="op">(</span><span class="va">GNM_pr</span>, <span class="va">GNM_pr_md</span><span class="op">)</span></span>
<span><span class="co"># Likelihood ratio test</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Model 1: prpsqm ~ size + age + dist_metro</span></span>
<span><span class="co"># Model 2: prpsqm ~ size + age + dist_metro + foreigners + prgreensp + popdens + </span></span>
<span><span class="co">#     museums + airbnb</span></span>
<span><span class="co">#   #Df  LogLik Df  Chisq Pr(&gt;Chisq)  </span></span>
<span><span class="co"># 1  10 -7783.9                       </span></span>
<span><span class="co"># 2  20 -7773.4 10 20.956     0.0214 *</span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we drop the municipality department level variables from the Durbin term, we lose fewer degrees of freedom, so preferring the model including the municipality department level variables:</p>
<div class="cell">
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">GNM_pr_md1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/ML_models.html">sacsarlm</a></span><span class="op">(</span><span class="va">f_pr_md</span>, data<span class="op">=</span><span class="va">properties_in_dd</span>, listw<span class="op">=</span><span class="va">lw</span>, </span>
<span>    Durbin<span class="op">=</span> <span class="op">~</span> <span class="va">size</span> <span class="op">+</span> <span class="va">age</span> <span class="op">+</span> <span class="va">dist_metro</span>,</span>
<span>    control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>pre_eig1<span class="op">=</span><span class="va">eigs</span>, pre_eig2<span class="op">=</span><span class="va">eigs</span><span class="op">)</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">lmtest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/lmtest/man/lrtest.html">lrtest</a></span><span class="op">(</span><span class="va">GNM_pr</span>, <span class="va">GNM_pr_md1</span><span class="op">)</span></span>
<span><span class="co"># Likelihood ratio test</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Model 1: prpsqm ~ size + age + dist_metro</span></span>
<span><span class="co"># Model 2: prpsqm ~ size + age + dist_metro + foreigners + prgreensp + popdens + </span></span>
<span><span class="co">#     museums + airbnb</span></span>
<span><span class="co">#   #Df  LogLik Df  Chisq Pr(&gt;Chisq)   </span></span>
<span><span class="co"># 1  10 -7783.9                        </span></span>
<span><span class="co"># 2  15 -7775.5  5 16.794   0.004908 **</span></span>
<span><span class="co"># ---</span></span>
<span><span class="co"># Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Unfortunately, impacts are depressing here:</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">trs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/trW.html">trW</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/methods/as.html">as</a></span><span class="op">(</span><span class="va">lw</span>, <span class="st">"CsparseMatrix"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">i_GNM_pr_md1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/impacts.html">impacts</a></span><span class="op">(</span><span class="va">GNM_pr_md1</span>, tr<span class="op">=</span><span class="va">trs</span>, R<span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">i_GNM_pr_md1</span>, short<span class="op">=</span><span class="cn">TRUE</span>, zstats<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Impact measures (sacmixed, trace):</span></span>
<span><span class="co">#                        Direct    Indirect        Total</span></span>
<span><span class="co"># size dy/dx         3.23740995   7.2985861   10.5359961</span></span>
<span><span class="co"># age dy/dx        -23.03565197  10.9935858  -12.0420662</span></span>
<span><span class="co"># dist_metro dy/dx   0.26484655  -0.4603147   -0.1954681</span></span>
<span><span class="co"># foreigners dy/dx  -5.71030959 -23.1783890  -28.8886986</span></span>
<span><span class="co"># prgreensp dy/dx    5.63045876  22.8542711   28.4847299</span></span>
<span><span class="co"># popdens dy/dx    -20.87711879 -84.7411115 -105.6182302</span></span>
<span><span class="co"># museums dy/dx     -4.03610471 -16.3827204  -20.4188251</span></span>
<span><span class="co"># airbnb dy/dx       0.09458806   0.3839369    0.4785250</span></span>
<span><span class="co"># ========================================================</span></span>
<span><span class="co"># Simulation results ( variance matrix):</span></span>
<span><span class="co"># ========================================================</span></span>
<span><span class="co"># Simulated standard errors</span></span>
<span><span class="co">#                      Direct    Indirect       Total</span></span>
<span><span class="co"># size dy/dx        0.3515519   2.6313560   2.7690564</span></span>
<span><span class="co"># age dy/dx         1.0792277   6.2786041   6.6742216</span></span>
<span><span class="co"># dist_metro dy/dx  0.2201011   0.3064794   0.1967609</span></span>
<span><span class="co"># foreigners dy/dx 11.7668825  48.2135999  59.9316334</span></span>
<span><span class="co"># prgreensp dy/dx   8.5473370  34.9664731  43.4713969</span></span>
<span><span class="co"># popdens dy/dx    54.4067199 223.2772512 277.4642424</span></span>
<span><span class="co"># museums dy/dx    10.8507063  44.5097871  55.3221381</span></span>
<span><span class="co"># airbnb dy/dx      0.1696704   0.6953895   0.8643763</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Simulated z-values:</span></span>
<span><span class="co">#                       Direct   Indirect      Total</span></span>
<span><span class="co"># size dy/dx         9.2080830  2.7537455  3.7858397</span></span>
<span><span class="co"># age dy/dx        -21.3453316  1.7486305 -1.8065799</span></span>
<span><span class="co"># dist_metro dy/dx   1.2050743 -1.5162497 -1.0137231</span></span>
<span><span class="co"># foreigners dy/dx  -0.4831598 -0.4756615 -0.4775214</span></span>
<span><span class="co"># prgreensp dy/dx    0.6588202  0.6506978  0.6529297</span></span>
<span><span class="co"># popdens dy/dx     -0.3958121 -0.3897357 -0.3912358</span></span>
<span><span class="co"># museums dy/dx     -0.3591685 -0.3560937 -0.3569436</span></span>
<span><span class="co"># airbnb dy/dx       0.5458623  0.5393548  0.5410587</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Simulated p-values:</span></span>
<span><span class="co">#                  Direct  Indirect  Total     </span></span>
<span><span class="co"># size dy/dx       &lt; 2e-16 0.0058918 0.00015319</span></span>
<span><span class="co"># age dy/dx        &lt; 2e-16 0.0803549 0.07082781</span></span>
<span><span class="co"># dist_metro dy/dx 0.22817 0.1294562 0.31071488</span></span>
<span><span class="co"># foreigners dy/dx 0.62898 0.6343155 0.63299086</span></span>
<span><span class="co"># prgreensp dy/dx  0.51001 0.5152416 0.51380160</span></span>
<span><span class="co"># popdens dy/dx    0.69224 0.6967320 0.69562295</span></span>
<span><span class="co"># museums dy/dx    0.71947 0.7217704 0.72113401</span></span>
<span><span class="co"># airbnb dy/dx     0.58516 0.5896421 0.58846711</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The values and standard errors of the spatial coefficients suggest numerical problems in finding an optimum where the two coefficients are equally strong but with opposing signs:</p>
<div class="cell">
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"response"</span><span class="op">=</span><span class="va">GNM_pr_md1</span><span class="op">$</span><span class="va">rho</span>, <span class="st">"response se"</span><span class="op">=</span><span class="va">GNM_pr_md1</span><span class="op">$</span><span class="va">rho.se</span>, <span class="st">"residual"</span><span class="op">=</span><span class="va">GNM_pr_md1</span><span class="op">$</span><span class="va">lambda</span>, <span class="st">"residual se"</span><span class="op">=</span><span class="va">GNM_pr_md1</span><span class="op">$</span><span class="va">lambda.se</span><span class="op">)</span></span>
<span><span class="co">#    response.rho     response se residual.lambda     residual se </span></span>
<span><span class="co">#      0.85971901      0.01547632     -0.86679315      0.04377824</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If we fall back on the properties level only GNM, total impacts are only significant in conventional terms for <code>size</code>:</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">i_GNM_pr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/spatialreg/reference/impacts.html">impacts</a></span><span class="op">(</span><span class="va">GNM_pr</span>, tr<span class="op">=</span><span class="va">trs</span>, R<span class="op">=</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">i_GNM_pr</span>, short<span class="op">=</span><span class="cn">TRUE</span>, zstats<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="co"># Impact measures (sacmixed, trace):</span></span>
<span><span class="co">#                       Direct   Indirect      Total</span></span>
<span><span class="co"># size dy/dx         3.3625460  9.2475109 12.6100569</span></span>
<span><span class="co"># age dy/dx        -22.7517472 16.8353181 -5.9164292</span></span>
<span><span class="co"># dist_metro dy/dx   0.2927231 -0.6523263 -0.3596032</span></span>
<span><span class="co"># ========================================================</span></span>
<span><span class="co"># Simulation results ( variance matrix):</span></span>
<span><span class="co"># ========================================================</span></span>
<span><span class="co"># Simulated standard errors</span></span>
<span><span class="co">#                     Direct  Indirect     Total</span></span>
<span><span class="co"># size dy/dx       0.3645917 2.7906415 2.9337088</span></span>
<span><span class="co"># age dy/dx        1.0206604 6.5683193 6.9130317</span></span>
<span><span class="co"># dist_metro dy/dx 0.2120890 0.3113081 0.2089585</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Simulated z-values:</span></span>
<span><span class="co">#                      Direct  Indirect      Total</span></span>
<span><span class="co"># size dy/dx         9.243400  3.332513  4.3187363</span></span>
<span><span class="co"># age dy/dx        -22.300663  2.566094 -0.8543972</span></span>
<span><span class="co"># dist_metro dy/dx   1.383807 -2.124059 -1.7599021</span></span>
<span><span class="co"># </span></span>
<span><span class="co"># Simulated p-values:</span></span>
<span><span class="co">#                  Direct  Indirect   Total     </span></span>
<span><span class="co"># size dy/dx       &lt; 2e-16 0.00086066 1.5693e-05</span></span>
<span><span class="co"># age dy/dx        &lt; 2e-16 0.01028508 0.392885  </span></span>
<span><span class="co"># dist_metro dy/dx 0.16642 0.03366523 0.078424</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The same problem occurs without the municipality department level variables; the impacts are being driven by the large spatial coefficient on the lagged response:</p>
<div class="cell">
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"response"</span><span class="op">=</span><span class="va">GNM_pr</span><span class="op">$</span><span class="va">rho</span>, <span class="st">"response se"</span><span class="op">=</span><span class="va">GNM_pr</span><span class="op">$</span><span class="va">rho.se</span>, <span class="st">"residual"</span><span class="op">=</span><span class="va">GNM_pr</span><span class="op">$</span><span class="va">lambda</span>, <span class="st">"residual se"</span><span class="op">=</span><span class="va">GNM_pr</span><span class="op">$</span><span class="va">lambda.se</span><span class="op">)</span></span>
<span><span class="co">#    response.rho     response se residual.lambda     residual se </span></span>
<span><span class="co">#      0.88013710      0.01319665     -0.89697824      0.03914311</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="exercise-17.5" class="level2 unnumbered"><h2 class="unnumbered anchored" data-anchor-id="exercise-17.5">Exercise 17.5</h2>
<p>We cannot say that the spatial econometrics approach has reached a clear conclusion. When including the upper level variables, we introduce a lot of spatial autocorrelation at the lower level. It is arguable that the MRF random effect at the upper level and including only the properties level variables gets at least as far as the most complex spatial econometrics models. It is fairly clear that mapping the actual green space and museums, and measuring distance from each property to the attractions would remove the scale problem for those variables. Disaggregation of the foreigners, airbnb and population density variables would be highly desirable. With improvements to the properties level data set, including more variables describing the properties themselves, much of the mis-specification should be removed.</p>


</section></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/edzer\.github\.io\/sdsr_exercises\/");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./16.html" class="pagination-link" aria-label="Spatial Regression">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">16</span>&nbsp; <span class="chapter-title">Spatial Regression</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
  </div>
</nav>
</div> <!-- /content -->



<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/edzer/sdsr_exercises/edit/main/17.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li></ul></div></div></div></footer></body></html>